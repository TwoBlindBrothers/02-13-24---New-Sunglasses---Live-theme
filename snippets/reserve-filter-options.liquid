{% comment %}
    Renders facets (filtering and sorting)

    Accepts:
    - results: {Object} Collection or Search object
    - enable_filtering: {Boolean} Show filtering when true
    - enable_sorting: {Boolean} Show sorting when true
    - filter_type: {String} Type of filter

    Usage:
    {% render 'facets', results: collection, enable_filtering: true, enable_sorting: true, filter_type: 'vertical' %}
{% endcomment %}

{%- liquid
  assign sort_by = results.sort_by | default: results.default_sort_by
  assign total_active_values = 0
  if results.url
    assign results_url = results.url
  else
    assign terms = results.terms | escape
    assign results_url = '?q=' | append: terms | append: '&options%5Bprefix%5D=last&sort_by=' | append: sort_by
  endif
-%}

<div class="facets-container !w-full !flex !pt-0 justify-between items-center">
  <div class="facets__results hidden sm:flex items-center gap-6">
    <div class="product-count light w-[120px] shrink-0" role="status">
      <h2 class="label normal-case">
        <span id="ProductCount" class="mobile-facets__count label">
          {%- if results.results_count -%}
            {{ results.results_count }}
          {%- else -%}
            {{ results.products_count }}
          {%- endif -%}
        </span>
        results
      </h2>
      <div class="loading-overlay__spinner">
        <svg aria-hidden="true" focusable="false" role="presentation" class="spinner" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
          <circle class="path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
        </svg>
      </div>
    </div>

    <div class="active-facets active-facets-mobile">
      {%- for filter in results.filters -%}
        {%- for value in filter.active_values -%}
          <facet-remove>
            <a href="{{ value.url_to_remove }}" class="active-facets__button active-facets__button--light">
            <span class="active-facets__button-inner bg-grey-200 rounded-[10px] px-2.5 py-[3px]">
              {{ filter.label }}: {{ value.label | escape }}
              <span class="visually-hidden">Clear</span>
            </span>
            </a>
          </facet-remove>
        {%- endfor -%}

        {%- if filter.type == "price_range" -%}
          {%- if filter.min_value.value != nil or filter.max_value.value != nil -%}
            <facet-remove>
              <a href="{{ filter.url_to_remove }}" class="active-facets__button active-facets__button--light">
              <span class="active-facets__button-inner bg-grey-200 rounded-[10px] px-2.5 py-[3px]">
                {%- if filter.min_value.value -%}{{ filter.min_value.value | money }}{%- else -%}{{ 0 | money }}{%- endif -%}-{%- if filter.max_value.value -%}{{ filter.max_value.value | money }}{%- else -%}{{ filter.range_max | money }}{%- endif -%}
                <span class="visually-hidden">Clear</span>
              </span>
              </a>
            </facet-remove>
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
      <facet-remove class="active-facets__button-wrapper">
        <a href="{{ results_url }}" class="active-facets__button-remove reserve-link underline">
          <span>Clear All</span>
        </a>
      </facet-remove>
    </div>
  </div>

  <div class="facets__filter w-full sm:w-fit flex justify-between sm:justify-end items-center gap-6">
    {% comment %}  Drawer and mobile filter {% endcomment %}
    <menu-drawer class="mobile-facets__wrapper" data-breakpoint="mobile">
      <details class="mobile-facets__disclosure disclosure-has-popup">
        <summary class="mobile-facets__open-wrapper focus-offset">
          <span class="mobile-facets__open">
            <span class="mobile-facets__open-label button-label flex label items-center">
              {%- if enable_filtering -%}
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M22 14H8.9375M6.5625 14H3M16.0625 9H3M22 9H18.4375M7.75 12C8.06494 12 8.36699 12.1054 8.58969 12.2929C8.81239 12.4804 8.9375 12.7348 8.9375 13V15C8.9375 15.2652 8.81239 15.5196 8.58969 15.7071C8.36699 15.8946 8.06494 16 7.75 16C7.43506 16 7.13301 15.8946 6.91031 15.7071C6.68761 15.5196 6.5625 15.2652 6.5625 15V13C6.5625 12.7348 6.68761 12.4804 6.91031 12.2929C7.13301 12.1054 7.43506 12 7.75 12ZM17.25 7C17.5649 7 17.867 7.10536 18.0897 7.29289C18.3124 7.48043 18.4375 7.73478 18.4375 8V10C18.4375 10.2652 18.3124 10.5196 18.0897 10.7071C17.867 10.8946 17.5649 11 17.25 11C16.9351 11 16.633 10.8946 16.4103 10.7071C16.1876 10.5196 16.0625 10.2652 16.0625 10V8C16.0625 7.73478 16.1876 7.48043 16.4103 7.29289C16.633 7.10536 16.9351 7 17.25 7Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Filter
              {%- endif -%}
            </span>
          </span>
        </summary>
        <facet-filters-form>
          <form id="FacetFiltersFormMobile" class="mobile-facets">
            <div class="mobile-facets__inner gradient">
              <div class="mobile-facets__header">
                <div class="mobile-facets__header-inner">
                  <p class="label">
                    Filters
                  </p>
                </div>
              </div>
              <div class="mobile-facets__main has-submenu gradient">
                {%- if enable_filtering -%}
                  {%- for filter in results.filters -%}
                    {% case filter.type %}
                    {% when 'boolean' or 'list' %}
                      <details id="Details-Mobile-{{ forloop.index }}-{{ section.id }}" class="mobile-facets__details js-filter" data-index="mobile-{{ forloop.index }}">
                        <summary class="mobile-facets__summary focus-inset">
                          <div class="flex justify-between items-center">
                            <span class="label">{{ filter.label | escape }}</span>
                            <span class="mobile-facets__arrow flex !ml-1">
                              <svg xmlns="http://www.w3.org/2000/svg" width="9" height="6" viewBox="0 0 9 6" fill="none">
                                <path d="M8.3642 1.33545L4.39199 4.6646L0.635803 1.33545" stroke="black"/>
                              </svg>
                            </span>
                          </div>
                        </summary>
                        <div id="FacetMobile-{{ forloop.index }}-{{ section.id }}" class="mobile-facets__submenu gradient">
                          <ul class="mobile-facets__list list-unstyled" role="list">
                            {%- for value in filter.values -%}
                              <li class="mobile-facets__item list-menu__item">
                                <label for="Filter-{{ filter.param_name | escape }}-mobile-{{ forloop.index }}" class="mobile-facets__label{% if value.count == 0 and value.active == false %} mobile-facets__label--disabled{% endif %}">
                                  <input class="mobile-facets__checkbox" type="checkbox" name="{{ value.param_name }}" value="{{ value.value }}" id="Filter-{{ filter.param_name | escape }}-mobile-{{ forloop.index }}"
                                         {% if value.active %}checked{% endif %}
                                    {% if value.count == 0 and value.active == false %}disabled{% endif %}
                                  >

                                  <span class="mobile-facets__highlight"></span>

                                  <svg width="1.6rem" height="1.6rem" viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                                    <rect width="16" height="16" stroke="currentColor" fill="none" stroke-width="1"></rect>
                                  </svg>

                                  <svg class="icon icon-checkmark" width="1.1rem" height="0.7rem" viewBox="0 0 11 7" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1.5 3.5L2.83333 4.75L4.16667 6L9.5 1" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" />
                                  </svg>

                                  <span aria-hidden="true">{{ value.label | escape }} ({{ value.count }})</span>
                                  <span class="visually-hidden">{{ value.label | escape }} ({% if value.count == '1' %}{{ value.count }}{% else %}{{ value.count }}{% endif %})</span>
                                </label>
                              </li>
                            {%- endfor -%}
                          </ul>
                        </div>
                      </details>
                    {% when 'price_range' %}
                      <details id="Details-Mobile-{{ forloop.index }}-{{ section.id }}" class="mobile-facets__details js-filter" data-index="mobile-{{ forloop.index }}">
                        <summary class="mobile-facets__summary focus-inset">
                          <div>
                            <span>{{ filter.label | escape }}</span>
                            <span class="mobile-facets__arrow no-js-hidden">{% render 'icon-arrow' %}</span>
                            <noscript>{% render 'icon-caret' %}</noscript>
                          </div>
                        </summary>
                        <div id="FacetMobile-{{ forloop.index }}-{{ section.id }}" class="mobile-facets__submenu gradient">
                          <button class="mobile-facets__close-button link link--text focus-inset" aria-expanded="true" type="button">
                            {% render 'icon-arrow' %}
                            {{ filter.label | escape }}
                          </button>

                          {%- assign max_price_amount = filter.range_max | money | strip_html | escape -%}
                          <p class="mobile-facets__info">{{ max_price_amount }}</p>

                          <price-range class="facets__price">
                            <span class="field-currency">{{ cart.currency.symbol }}</span>
                            <div class="field">
                              <input class="field__input"
                                     name="{{ filter.min_value.param_name }}"
                                     id="Mobile-Filter-{{ filter.label | escape }}-GTE"
                                {%- if filter.min_value.value -%}
                                  {%- if uses_comma_decimals -%}value="{{ filter.min_value.value | money_without_currency | replace: '.', '' | replace: ',', '.' }}"{%- else -%}value="{{ filter.min_value.value | money_without_currency | replace: ',', '' }}"{% endif %}
                                {%- endif -%}
                                     type="number"
                                     placeholder="0"
                                     min="0"
                                     inputmode="decimal"
                                {%- if uses_comma_decimals -%}max="{{ filter.range_max | money_without_currency | replace: '.', '' | replace: ',', '.' }}"{%- else -%}max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"{% endif %}
                              >
                              <label class="field__label" for="Mobile-Filter-{{ filter.label | escape }}-GTE">FORM</label>
                            </div>

                            <span class="field-currency">{{ cart.currency.symbol }}</span>
                            <div class="field">
                              <input class="field__input"
                                     name="{{ filter.max_value.param_name }}"
                                     id="Mobile-Filter-{{ filter.label | escape }}-LTE"
                                {%- if filter.max_value.value -%}
                                  {%- if uses_comma_decimals -%}value="{{ filter.max_value.value | money_without_currency | replace: '.', '' | replace: ',', '.' }}"{%- else -%}value="{{ filter.max_value.value | money_without_currency | replace: ',', '' }}"{% endif %}
                                {%- endif -%}
                                     type="number"
                                     min="0"
                                     inputmode="decimal"
                                {%- if uses_comma_decimals -%}
                                  placeholder="{{ filter.range_max | money_without_currency | replace: '.', '' | replace: ',', '.' }}"
                                  max="{{ filter.range_max | money_without_currency | replace: '.', '' | replace: ',', '.' }}"
                                {%- else -%}
                                  placeholder="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                                  max="{{ filter.range_max | money_without_currency | replace: ',', '' }}"
                                {% endif %}
                              >
                              <label class="field__label" for="Mobile-Filter-{{ filter.label | escape }}-LTE">TO</label>
                            </div>
                          </price-range>
                        </div>
                      </details>
                    {% endcase %}
                  {%- endfor -%}
                {%- endif -%}

                <div class="mobile-facets__footer">
                  <facet-remove class="mobile-facets__clear-wrapper">
                    <a href="{{ results_url }}" class="mobile-facets__clear reserve-link underline">Clear All</a>
                  </facet-remove>
                </div>
              </div>

              {% if results.current_vendor or results.current_type %}
                <input type="hidden" name="q" value="{{ results.current_vendor }}{{ results.current_type }}">
              {% endif %}

              {%- if results.terms -%}
                <input type="hidden" name="q" value="{{ results.terms | escape }}">
                <input name="options[prefix]" type="hidden" value="last">
              {%- endif -%}
            </div>
          </form>
        </facet-filters-form>
      </details>
    </menu-drawer>
    {%- if filter_type == 'horizontal' -%}
      <facet-filters-form class="facets ">
        <form id="FacetFiltersForm" class="">
          {%- if results.terms -%}
            <input type="hidden" name="q" value="{{ results.terms | escape }}">
            <input name="options[prefix]" type="hidden" value="last">
          {%- endif -%}

          {% if results.current_vendor or results.current_type %}
            <input type="hidden" name="q" value="{{ results.current_vendor }}{{ results.current_type }}">
          {% endif %}

          {% comment %} Sorting and product count are the last elements when filter type is horizontal {% endcomment %}
          {%- if enable_sorting -%}
            <div class="sorting caption">
              <div class="facet-filters__field">
                <h2 class="label normal-case mr-1">
                  <label for="SortBy">Sort:</label>
                </h2>
                <div class="select label">
                  {%- assign sort_by = results.sort_by | default: results.default_sort_by -%}
                  <select name="sort_by" class="facet-filters__sort select__select" id="SortBy" aria-describedby="a11y-refresh-page-message">
                    {%- for option in results.sort_options -%}
                      <option value="{{ option.value | escape }}"{% if option.value == sort_by %} selected="selected"{% endif %}>{{ option.name | escape }}</option>
                    {%- endfor -%}
                  </select>
                </div>
              </div>

              <noscript>
                <button type="submit" class="facets__button-no-js button button--secondary">Sort Products</button>
              </noscript>
            </div>
          {%- endif -%}
        </form>
      </facet-filters-form>
    {%- endif -%}
  </div>
</div>

<script>
    $('.no-js-hidden').hide();
</script>